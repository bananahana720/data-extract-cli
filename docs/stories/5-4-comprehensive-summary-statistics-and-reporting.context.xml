<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>4</storyId>
    <title>Comprehensive Summary Statistics and Reporting</title>
    <status>drafted</status>
    <generatedAt>2025-11-29</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-4-comprehensive-summary-statistics-and-reporting.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>detailed summary statistics displayed through Rich panels after processing completes</iWant>
    <soThat>I understand what was processed, quality metrics, per-stage timing, and actionable next steps</soThat>
    <tasks>
      <task n="1" title="Create Summary Report Module">
        <subtask>1.1 Create src/data_extract/cli/summary.py module</subtask>
        <subtask>1.2 Implement SummaryReport dataclass with fields: files_processed, chunks_created, errors, quality_metrics, timing, config</subtask>
        <subtask>1.3 Implement render_summary_panel() using Rich Panel component</subtask>
        <subtask>1.4 Implement render_quality_dashboard() using Rich Table component</subtask>
        <subtask>1.5 Add quality distribution bars (Excellent/Good/Review categories)</subtask>
        <subtask>1.6 Include configuration section showing CLI options used for reproducibility</subtask>
        <subtask>1.7 Write unit tests for SummaryReport dataclass</subtask>
        <subtask>1.8 Write unit tests for render functions with console mock</subtask>
      </task>
      <task n="2" title="Implement Per-Stage Timing">
        <subtask>2.1 Create StageTimer class with start/stop/elapsed methods</subtask>
        <subtask>2.2 Define stage names: EXTRACT, NORMALIZE, CHUNK, SEMANTIC, OUTPUT</subtask>
        <subtask>2.3 Implement timing breakdown table in Rich format</subtask>
        <subtask>2.4 Integrate timing into process command</subtask>
        <subtask>2.5 Integrate timing into semantic commands</subtask>
        <subtask>2.6 Write unit tests for StageTimer class</subtask>
      </task>
      <task n="3" title="Enhance Process Command Summary">
        <subtask>3.1 Replace basic click.echo output with Rich Panel in app.py</subtask>
        <subtask>3.2 Add per-stage timing to process command output</subtask>
        <subtask>3.3 Add error summary panel when errors occur</subtask>
        <subtask>3.4 Add "Next Steps" recommendations based on results</subtask>
        <subtask>3.5 Write integration test for process command Rich output</subtask>
      </task>
      <task n="4" title="Enhance Semantic Commands Summary">
        <subtask>4.1 Update _display_summary() in semantic_commands.py to use new SummaryReport</subtask>
        <subtask>4.2 Add quality distribution bars matching Journey 3 UX spec</subtask>
        <subtask>4.3 Add topic summary section for analyze command</subtask>
        <subtask>4.4 Add actionable suggestions</subtask>
        <subtask>4.5 Update deduplicate command summary panel</subtask>
        <subtask>4.6 Update cluster command summary panel</subtask>
        <subtask>4.7 Write integration tests for semantic command summaries</subtask>
      </task>
      <task n="5" title="Implement Export Functionality">
        <subtask>5.1 Add --export-summary option to process command</subtask>
        <subtask>5.2 Add --export-summary option to semantic commands</subtask>
        <subtask>5.3 Implement TXT export format (plain text version of summary)</subtask>
        <subtask>5.4 Implement JSON export format (structured data)</subtask>
        <subtask>5.5 Implement HTML export format (styled report)</subtask>
        <subtask>5.6 Write unit tests for each export format</subtask>
        <subtask>5.7 Write integration tests for export file creation</subtask>
      </task>
      <task n="6" title="NO_COLOR Support">
        <subtask>6.1 Add NO_COLOR environment variable check to Rich console initialization</subtask>
        <subtask>6.2 Test output with NO_COLOR=1 set</subtask>
        <subtask>6.3 Document NO_COLOR support in help text</subtask>
      </task>
      <task n="7" title="Quality Gates and Documentation">
        <subtask>7.1 Run Black formatting on all modified files</subtask>
        <subtask>7.2 Run Ruff linting on all modified files</subtask>
        <subtask>7.3 Run Mypy type checking on all modified files</subtask>
        <subtask>7.4 Add docstrings to all public functions</subtask>
        <subtask>7.5 Update CLI --help text with new options</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-5.4-1">Summary panels using Rich Panel/Table components are displayed for ALL commands (process, semantic analyze, semantic deduplicate, semantic cluster)</criterion>
    <criterion id="AC-5.4-2">Per-stage timing breakdown shows duration for each pipeline stage (Extract, Normalize, Chunk, Semantic, Output) when applicable</criterion>
    <criterion id="AC-5.4-3">Quality metrics dashboard displays: avg OCR confidence, flagged chunks count, entities identified, readability scores, duplicate percentage, coverage metrics</criterion>
    <criterion id="AC-5.4-4">Export formats (TXT, JSON, HTML) are functional for summary reports via --export option</criterion>
    <criterion id="AC-5.4-5">Journey 3 (Semantic Analysis) reports enhanced with quality distribution bars, topic summaries, and actionable suggestions</criterion>
    <criterion id="AC-5.4-6">Error summary lists each failed file with actionable suggestions</criterion>
    <criterion id="AC-5.4-7">Next step recommendations are provided after processing</criterion>
    <criterion id="AC-5.4-8">Summary includes processing configuration for reproducibility</criterion>
    <criterion id="AC-5.4-9">All summary output respects NO_COLOR environment variable</criterion>
    <criterion id="AC-5.4-10">Quality gates pass: Black, Ruff, Mypy with 0 violations</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-5.md" title="Epic 5 Technical Specification" section="3.4 Error Recovery Architecture" snippet="Story 5-4 delivers rich interactive feedback with Summary Statistics and Reporting, implementing the 'Tool as Teacher' philosophy."/>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Journey 3: Semantic Analysis" snippet="Results Dashboard with Quality Distribution bars showing Excellent/Good/Review categories, Top Topics, and actionable near-duplicate suggestions."/>
      <doc path="CLAUDE.md" title="Project Instructions" section="Quality Gates" snippet="Pre-commit workflow requires Black, Ruff, Mypy to pass with 0 violations. Fix validation issues immediately."/>
    </docs>
    <code>
      <artifact path="src/data_extract/cli/summary.py" kind="module" symbol="SummaryReport, StageTimer, QualityMetrics, render_summary_panel, render_quality_dashboard" lines="1-842" reason="EXISTING: Core summary module with frozen dataclasses for comprehensive statistics, stage timing, quality distribution, and Rich rendering functions"/>
      <artifact path="src/data_extract/cli/base.py" kind="module" symbol="process, semantic, config, status" lines="889-2565" reason="Main CLI entry point with Typer commands - process command needs Rich Panel integration"/>
      <artifact path="src/data_extract/semantic/reporting.py" kind="module" symbol="generate_html_report, generate_csv_report, generate_cluster_html" lines="1-300" reason="EXISTING: HTML/CSV report generation patterns for semantic analysis - reference for export format patterns"/>
      <artifact path="src/data_extract/cli/components/panels.py" kind="component" symbol="Panel patterns" lines="all" reason="Rich Panel component patterns for consistent styling"/>
      <artifact path="src/data_extract/cli/components/progress.py" kind="component" symbol="Progress tracking" lines="all" reason="Story 5-3 progress infrastructure - timing integration reference"/>
      <artifact path="src/data_extract/semantic/quality_metrics.py" kind="module" symbol="QualityMetrics" lines="all" reason="Quality metrics calculation - readability scores, coverage"/>
    </code>
    <dependencies>
      <python>
        <package name="rich" version=">=13.0.0" purpose="Terminal formatting with Panel, Table, Progress"/>
        <package name="typer" version=">=0.9.0" purpose="CLI framework with subcommand support"/>
        <package name="textstat" version=">=0.7.3" purpose="Readability metrics (Flesch, SMOG)"/>
        <package name="pydantic" version=">=2.0.0" purpose="Runtime validation for summary models"/>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Use frozen dataclasses for immutable summary data structures per ADR-001</constraint>
    <constraint type="pattern">All Rich Panel components must support NO_COLOR environment variable</constraint>
    <constraint type="pattern">Export functions should be async if >1MB output per tech spec</constraint>
    <constraint type="performance">Summary generation should be less than 100ms</constraint>
    <constraint type="performance">Memory overhead less than 50MB for CLI infrastructure</constraint>
    <constraint type="layer">CLI summary module in src/data_extract/cli/ - do not modify brownfield cli/ package</constraint>
    <constraint type="testing">Mirror test structure to src/ exactly (tests/unit/test_cli/test_summary_report.py)</constraint>
  </constraints>

  <interfaces>
    <interface name="SummaryReport" kind="dataclass" path="src/data_extract/cli/summary.py">
      <signature>@dataclass(frozen=True) class SummaryReport: files_processed, chunks_created, errors, quality_metrics, timing, config</signature>
    </interface>
    <interface name="StageTimer" kind="class" path="src/data_extract/cli/summary.py">
      <signature>class StageTimer: __init__(stage: StageName), start(), stop(), elapsed() -> float</signature>
    </interface>
    <interface name="render_summary_panel" kind="function" path="src/data_extract/cli/summary.py">
      <signature>def render_summary_panel(report: SummaryReport, console: Console) -> None</signature>
    </interface>
    <interface name="export_summary" kind="function" path="src/data_extract/cli/summary.py">
      <signature>def export_summary(report: SummaryReport, format: ExportFormat, path: Path) -> None</signature>
    </interface>
    <interface name="process command" kind="CLI endpoint" path="src/data_extract/cli/base.py">
      <signature>@app.command() def process(input_path, output_path, --export-summary)</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
      pytest with fixtures, markers (unit, integration, performance), mock Rich console for component tests.
      Continue existing patterns from tests/unit/test_cli/. Use frozen dataclass factories for test data.
      80%+ coverage on new code per CLAUDE.md requirements.
    </standards>
    <locations>
      <location>tests/unit/test_cli/test_summary_report.py - Unit tests for dataclasses and render functions</location>
      <location>tests/integration/test_cli/test_summary_integration.py - CLI command integration</location>
      <location>tests/performance/test_summary_performance.py - Summary generation benchmarks</location>
      <location>tests/behavioral/epic_5/test_summary_report_behavior.py - Behavioral tests</location>
      <location>tests/uat/journeys/test_journey_3_summary_statistics.py - Journey 3 UAT tests</location>
    </locations>
    <ideas>
      <idea ac="AC-5.4-1">Test Rich Panel rendering for each command type with console capture</idea>
      <idea ac="AC-5.4-2">Test StageTimer accuracy and timing breakdown format</idea>
      <idea ac="AC-5.4-3">Test quality metrics dashboard shows all required metrics</idea>
      <idea ac="AC-5.4-4">Test TXT/JSON/HTML export produces valid output files</idea>
      <idea ac="AC-5.4-5">Test Journey 3 quality distribution bars match UX spec percentages</idea>
      <idea ac="AC-5.4-6">Test error panel shows failed files with suggestions</idea>
      <idea ac="AC-5.4-7">Test next steps section appears based on result context</idea>
      <idea ac="AC-5.4-8">Test configuration section includes all CLI options used</idea>
      <idea ac="AC-5.4-9">Test NO_COLOR=1 disables Rich formatting</idea>
      <idea ac="AC-5.4-10">Test quality gates pass with black/ruff/mypy check</idea>
    </ideas>
  </tests>
</story-context>
